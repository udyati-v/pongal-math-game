<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankranti Math Harvest</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #e67e22;
            --secondary: #27ae60;
            --accent: #f1c40f;
            --bg-gradient: linear-gradient(#7a0c0c, #c0392b, #f39c12);
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-gradient);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .bg-element { position: fixed; z-index: 0; pointer-events: none; opacity: 0.25; }
        .sun { width: 140px; height: 140px; background: radial-gradient(circle, #ffd54f, #ff9800); 
               border-radius: 50%; top: -20px; right: -20px; box-shadow: 0 0 40px #f1c40f; }
        .cane { width: 12px; height: 280px; background: linear-gradient(#1e7f34, #3cb371); bottom: 0; left: 15px; }

        .card {
            width: 92%;
            max-width: 520px;
            margin: 40px auto;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            padding: 25px;
            border-radius: 24px;
            position: relative;
            z-index: 10;
            box-shadow: 0 10px 50px rgba(0,0,0,0.7);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        h1 { color: var(--accent); margin-bottom: 8px; font-size: 1.8rem; }
        .intro-line { font-size: 1rem; line-height: 1.6; margin-bottom: 20px; opacity: 0.9; }
        
        input {
            width: 100%;
            padding: 14px;
            margin: 15px 0;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            box-sizing: border-box;
            background: #fff;
            color: #333;
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-green { background: var(--secondary); color: white; }
        .btn-orange { background: var(--primary); color: white; margin-top: 12px; }
        .btn-disabled { background: #444 !important; cursor: not-allowed; color: #888; }

        .hidden { display: none !important; }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            font-size: 1.2rem;
            font-weight: bold;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 15px;
        }

        #questionText { 
            text-align: left; 
            font-size: 1.1rem; 
            line-height: 1.6; 
            margin: 20px 0;
            white-space: pre-wrap; 
        }
        
        .brownie-tag { 
            color: var(--accent); 
            font-weight: bold; 
            background: rgba(241, 196, 15, 0.2);
            padding: 12px;
            border-radius: 10px;
            display: block; 
            margin-bottom: 15px; 
        }

        .leader-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>

<div class="bg-element sun"></div>
<div class="bg-element cane"></div>

<div class="card" id="startPage">
    <h1>Sankranti Math Harvest</h1>
    <p class="intro-line">Beat the Clock ‚è∞Ô∏è! Solve More ‚ûïÔ∏è score more ‚ú®Ô∏è, top 3 wins prizes üèÜ</p>
    <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
    <button id="startBtn" class="btn-green btn-disabled">Start Game</button>
</div>

<div class="card hidden" id="gamePage">
    <div id="brownieMessage" class="brownie-tag hidden">Start sweet: Brownie questions for Sihi huggi bonus points!</div>
    <h3 id="qNumber" style="margin:0; color:var(--accent); text-align: left;">Question 1</h3>
    <div id="questionText"></div>

    <input type="text" id="answerInput" placeholder="Type answer or option (a, b, c...)" autocomplete="off">
    <button class="btn-green" id="submitBtn">Submit Answer</button>
    <button class="btn-orange hidden" id="skipBtn">Skip Question</button>

    <div class="status-bar">
        <span>‚è≥ <span id="timerDisplay">2:00</span></span>
        <span>‚≠ê <span id="scoreDisplay">0</span></span>
    </div>
</div>

<div class="card hidden" id="leaderboardPage">
    <h1>üèÜ Leaderboard</h1>
    <div id="leaderboardList">Calculating Harvest Results...</div>
</div>

<script>
/* --- CONFIG & DATA --- */
const firebaseConfig = {
    apiKey: "AIzaSyBnFhuDbItM9kwjMgeDVrvMlWy5p-dNaLM",
    authDomain: "pongal-math-game.firebaseapp.com",
    projectId: "pongal-math-game",
    storageBucket: "pongal-math-game.firebasestorage.app",
    messagingSenderId: "656858683321",
    appId: "1:656858683321:web:00532718045127c3778868"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const compulsoryQuestions = [
    { q: "What does July ‚Äì June signify:\n\na) Crop year\nb) Financial year\nc) Academic year", a: ["a", "cropyear"] },
    { q: "Pi hide & seek! Spot the pi in the invite\n\na) Temple\nb) Stove\nc) Sugarcane", a: ["b", "stove", "pot"] },
    { q: "Spot the handsome duo in this flyer?\n(Hint: One cracked equations in dreams, the other is the Father of Indian Mathematics!)\n\na) Harish Chandra and Bhaskaracharya\nb) P.C. Mahalanobis and Satyendra Nath Bose\nc) Srinivasa Ramanujan and Aryabhata", a: ["c", "ramanujan", "aryabhata"] },
    { q: "What does Sankranti signify astronomically?\n\na) Full moon day\nb) Sun‚Äôs transition into Capricorn (Makara Rashi)\nc) Start of winter\nd) Spring", a: ["b", "capricorn", "makara"] },
    { q: "Why are kites flown during Sankranti?\n\na) For entertainment only\nb) To scare birds away\nc) To mark the monsoon season\nd) To welcome the Sun‚Äôs northward journey (Uttarayan)", a: ["d", "uttarayan"] },
    { q: "Stove ain't apple pie üòÇ, it‚Äôs œÄ‚Ä¶ why?\n\na) Nature‚Äôs infinite harvest loop in life‚Äôs eternal abundance circle\nb) Because œÄ represents the number of cashews used in making pongal", a: ["a", "nature"] },
    { q: "Total Harvest = 750 kg\nRice constitutes 40% of the total harvest.\nHow many kilograms of rice were harvested?\n\na) 300 kg\nb) 250 kg\nc) 350 kg", a: ["a", "300"] }
];

const poolQuestions = [
    { q: "Evaluate: log‚ÇÇ(32)", a: ["5"] },
    { q: "If f(x) = 2x + 3 and g(x) = x¬≤, find f(g(2)).", a: ["11"] },
    { q: "Find the gradient (slope) of the line: 3x + y = 10", a: ["-3"] },
    { q: "Solve for x: 5^(x-1) = 25", a: ["3"] },
    { q: "A Pongal pot has a diameter of 20cm. What is the radius?", a: ["10"] },
    { q: "In a geometric sequence, u‚ÇÅ = 3 and r = 2. Find the 4th term (u‚ÇÑ).", a: ["24"] },
    { q: "State the vertical asymptote of: f(x) = 1 / (x - 5)", a: ["x=5", "5"] },
    { q: "Evaluate: log‚ÇÖ(1)", a: ["0"] },
    { q: "Solve for x: ln(x) = 0", a: ["1"] },
    { q: "Find the midpoint between points (2, 4) and (6, 10).", a: ["4,7"] },
    { q: "If a kite string makes a 45¬∞ angle with the ground, what is the gradient of the string?", a: ["1"] },
    { q: "Expand and simplify: (x + 3)(x - 3)", a: ["x^2-9"] },
    { q: "What is the period of the function: y = sin(x)", a: ["360", "2pi"] },
    { q: "Find the value of 2‚Åª¬≥ as a fraction.", a: ["1/8"] },
    { q: "A harvest bag weighs 15.4 kg. Convert this to grams.", a: ["15400"] },
    { q: "If 3 men can harvest a field in 6 hours, how many hours for 6 men?", a: ["3"] },
    { q: "Calculate the discriminant (Œî) for: x¬≤ + 4x + 4 = 0", a: ["0"] },
    { q: "Find the sum of the interior angles of a triangle.", a: ["180"] },
    { q: "Solve for x: ‚àö(2x + 1) = 3", a: ["4"] },
    { q: "A farmer has 200 cows and 15% are calves. How many calves?", a: ["30"] },
    { q: "If f(x) = x¬≤ ‚àí 4, find the value of f(2).", a: ["0"] },
    { q: "Find the y-intercept of: y = 2x ‚àí 5", a: ["-5"] },
    { q: "Evaluate: log‚ÇÅ‚ÇÄ(1000)", a: ["3"] },
    { q: "Find ‚àö169", a: ["13"] },
    { q: "Solve for x: 3x ‚àí 9 = 0", a: ["3"] },
    { q: "Simplify the ratio 18:24", a: ["3:4"] }
];

/* --- ENGINE --- */
let currentIndex = 0;
let score = 0;
let timeLeft = 120; 
let timerInterval;
let questions = [];
let gameEnded = false;

// Attempt check
if(localStorage.getItem("sankranti_attempt") === "done") {
    document.body.innerHTML = "<div class='card'><h1>Harvest Finished</h1><p>You have already completed your attempt on this device.</p></div>";
}

document.getElementById('playerName').oninput = function() {
    document.getElementById('startBtn').classList.toggle('btn-disabled', this.value.trim() === "");
};

document.getElementById('startBtn').onclick = function() {
    if(this.classList.contains('btn-disabled')) return;
    questions = [...compulsoryQuestions, ...poolQuestions.sort(() => Math.random() - 0.5)];
    document.getElementById('startPage').classList.add('hidden');
    document.getElementById('gamePage').classList.remove('hidden');
    startTimer();
    showQuestion();
};

function startTimer() {
    timerInterval = setInterval(() => {
        timeLeft--;
        let mins = Math.floor(timeLeft / 60);
        let secs = timeLeft % 60;
        document.getElementById('timerDisplay').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
        
        if(timeLeft <= 0) {
            endGame();
        }
    }, 1000);
}

function showQuestion() {
    if(currentIndex >= questions.length) return endGame();
    
    const currentQ = questions[currentIndex];
    document.getElementById('qNumber').innerText = `Question ${currentIndex + 1}`;
    document.getElementById('questionText').innerText = currentQ.q;
    document.getElementById('answerInput').value = "";
    document.getElementById('answerInput').focus();
    
    // Brownie message on Q1 only
    document.getElementById('brownieMessage').classList.toggle('hidden', currentIndex !== 0);
    
    // Skip rule: show ONLY starting from Question 7 (index 6)
    document.getElementById('skipBtn').classList.toggle('hidden', currentIndex < 6);
}

function normalize(str) {
    return str.toLowerCase().trim().replace(/[^a-z0-9.-]/g, "");
}

document.getElementById('submitBtn').onclick = submitAnswer;
document.getElementById('answerInput').onkeypress = (e) => { if(e.key === 'Enter') submitAnswer(); };

function submitAnswer() {
    if(gameEnded) return;
    const rawVal = document.getElementById('answerInput').value;
    if(!rawVal.trim()) return;

    const userVal = normalize(rawVal);
    const correctAnswers = questions[currentIndex].a;
    const isCorrect = correctAnswers.some(ans => normalize(ans) === userVal);

    if(isCorrect) score += 10;
    else score -= 2;

    document.getElementById('scoreDisplay').innerText = score;
    currentIndex++;
    showQuestion();
}

// Skip logic: moves to next question, no score change
document.getElementById('skipBtn').onclick = function() {
    if(gameEnded) return;
    currentIndex++;
    showQuestion();
};

async function endGame() {
    if(gameEnded) return;
    gameEnded = true;
    clearInterval(timerInterval);
    
    // Lock attempt
    localStorage.setItem("sankranti_attempt", "done");
    
    document.getElementById('gamePage').classList.add('hidden');
    document.getElementById('leaderboardPage').classList.remove('hidden');
    
    const name = document.getElementById('playerName').value.trim();

    try {
        await db.collection("leaderboard").add({
            name: name,
            score: score,
            time: Date.now()
        });
        showLeaderboard();
    } catch(e) {
        document.getElementById('leaderboardList').innerText = "Score saved locally. Sync error.";
    }
}

async function showLeaderboard() {
    const list = document.getElementById('leaderboardList');
    try {
        const snap = await db.collection("leaderboard")
            .orderBy("score", "desc")
            .limit(10)
            .get();

        let html = "";
        let rank = 1;
        snap.forEach(doc => {
            const d = doc.data();
            const medal = rank===1 ? "ü•á" : rank===2 ? "ü•à" : rank===3 ? "ü•â" : "";
            html += `<div class="leader-row">
                        <span><b>${rank}.</b> ${d.name} ${medal}</span>
                        <span style="color:var(--accent)">${d.score}</span>
                     </div>`;
            rank++;
        });
        list.innerHTML = html;
    } catch(e) {
        list.innerHTML = "Leaderboard error.";
    }
}
</script>
</body>
</html>
