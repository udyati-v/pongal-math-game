<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sankranti Math Harvest</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(#7a0c0c,#c0392b,#f39c12);
  color:#fff;
}

.bg-sun,.bg-cane,.bg-pot{
  position:fixed;
  opacity:0.22;
  z-index:0;
  pointer-events:none;
}

.bg-sun{
  width:160px;height:160px;
  background:radial-gradient(circle,#ffd54f,#ff9800);
  border-radius:50%;
  top:-40px;right:-70px;
}

.bg-cane{
  width:12px;height:240px;
  background:linear-gradient(#1e7f34,#3cb371);
  bottom:0;left:-25px;
}

.bg-pot{
  width:90px;height:70px;
  background:#8b4513;
  border-radius:0 0 45px 45px;
  bottom:-20px;right:-30px;
}

.card{
  max-width:540px;
  width:100%;
  margin:70px auto;
  background:rgba(0,0,0,0.65);
  padding:24px;
  border-radius:18px;
  position:relative;
  z-index:5;
}

input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
  font-size:16px;
}

.green{background:#27ae60;color:#fff;}
.orange{background:#e67e22;color:#fff;}
.disabled{background:#555;cursor:not-allowed;}
.hidden{display:none;}

.status{
  display:flex;
  justify-content:space-between;
  font-weight:bold;
  margin-top:15px;
}

.leader{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
}
</style>
</head>

<body>

<div class="bg-sun"></div>
<div class="bg-cane"></div>
<div class="bg-pot"></div>

<div class="card" id="startPage">
  <h1>Sankranti Math Harvest üåæ</h1>
  <p>Beat the Clock ‚è∞Ô∏è! Solve More ‚ûïÔ∏è score more ‚ú®,<br>top 3 wins prizes üèÜ</p>
  <input id="playerName" placeholder="Enter your name">
  <button id="startBtn" class="green disabled">Start Game</button>
</div>

<div class="card hidden" id="gamePage">
  <div id="questionNumber"></div>
  <div id="questionText"></div>

  <input id="answerInput" placeholder="Type your answer">
  <button class="green" id="submitBtn">Submit</button>
  <button class="orange hidden" id="skipBtn">Skip</button>

  <div class="status">
    <div>‚è≥ <span id="time">2:00</span></div>
    <div>‚≠ê <span id="score">0</span></div>
  </div>
</div>

<div class="card hidden" id="leaderboardPage">
  <h2>üèÜ Leaderboard</h2>
  <div id="leaderboard"></div>
</div>

<script>
/* FIREBASE INIT */
firebase.initializeApp({
  apiKey: "AIzaSyBnFhuDbItM9kwjMgeDVrvMlWy5p-dNaLM",
  authDomain: "pongal-math-game.firebaseapp.com",
  projectId: "pongal-math-game",
  storageBucket: "pongal-math-game.firebasestorage.app",
  messagingSenderId: "656858683321",
  appId: "1:656858683321:web:00532718045127c3778868"
});
const db = firebase.firestore();

/* ONE ATTEMPT RULE */
if(localStorage.getItem("completedGame")==="yes"){
  document.body.innerHTML="<h2 style='text-align:center;margin-top:40vh'>You have already completed the game on this device.</h2>";
}

/* DOM */
const startPage=document.getElementById("startPage");
const gamePage=document.getElementById("gamePage");
const leaderboardPage=document.getElementById("leaderboardPage");
const leaderboard=document.getElementById("leaderboard");

const questionNumber=document.getElementById("questionNumber");
const questionText=document.getElementById("questionText");
const answerInput=document.getElementById("answerInput");
const submitBtn=document.getElementById("submitBtn");
const skipBtn=document.getElementById("skipBtn");

const timeEl=document.getElementById("time");
const scoreEl=document.getElementById("score");
const nameInput=document.getElementById("playerName");
const startBtn=document.getElementById("startBtn");

/* START */
nameInput.oninput=()=>startBtn.classList.toggle("disabled",!nameInput.value.trim());

startBtn.onclick=()=>{
  if(startBtn.classList.contains("disabled"))return;
  startPage.classList.add("hidden");
  gamePage.classList.remove("hidden");
  startGame();
};

/* QUESTIONS */
const compulsory=[
{
q:`Start sweet: Brownie questions for Sihi huggi bonus points!

What does July ‚Äì June signify:
a) crop year
b) financial year
c) academic year`,
a:["a","cropyear"]
},
{
q:`Pi hide & seek! Spot the pi in the invite
a) Temple
b) Stove
c) Sugarcane`,
a:["b","stove"]
},
{
q:`Spot the handsome duo in this flyer?
(Hint: One cracked equations in dreams, the other is the Father of Indian Mathematics!)
a) Pythagoras and Carl Friedrich Gauss
b) Euler and Archimedes
c) Aryabhata and Srinivasa Ramanujan`,
a:["c","aryabhata","ramanujan"]
},
{
q:`What does Sankranti signify astronomically?
a) Full moon day
b) Sun‚Äôs transition into Capricorn (Makara Rashi)
c) Start of winter
d) Spring equinox`,
a:["b"]
},
{
q:`Why are kites flown during Sankranti?
a) For entertainment only
b) To scare birds away
c) To mark the monsoon season
d) To welcome the Sun‚Äôs northward journey (Uttarayan)`,
a:["d"]
},
{
q:`Stove ain't apple pie üòÇ, it‚Äôs œÄ‚Ä¶ why?
a) Nature‚Äôs infinite harvest loop in life‚Äôs eternal abundance circle
b) Because œÄ represents the number of cashews used in making pongal`,
a:["a"]
},
{
q:`Total Harvest = 750 kg  
Rice constitutes 40% of the total harvest.

How many kilograms of rice were harvested?
a) 300 kg
b) 250 kg
c) 350 kg`,
a:["a","300"]
}
];

const pool = [
{q:`If f(x)=x¬≤‚àí4, find the value of f(2).`,a:["0"]},
{q:`For f(x)=3x+1, find the value of x when f(x)=10.`,a:["3"]},
{q:`State whether f(x)=x¬≤ is even or odd.`,a:["even"]},
{q:`Find the y-intercept of the function y=2x‚àí5.`,a:["-5"]},
{q:`In y=(x‚àí3)¬≤, state the horizontal shift.`,a:["right3","3"]},
{q:`State the vertical translation in y=x¬≤+6.`,a:["up6","6"]},
{q:`What reflection occurs in y=‚àíf(x)?`,a:["xaxis"]},
{q:`Identify the stretch factor in y=4x¬≤.`,a:["4"]},
{q:`Evaluate log‚ÇÅ‚ÇÄ(1000).`,a:["3"]},
{q:`Evaluate log‚ÇÅ‚ÇÄ(0.01).`,a:["-2"]},
{q:`Solve log x = 1.`,a:["10"]},
{q:`Write log‚ÇÅ‚ÇÄ(100)=2 in exponential form.`,a:["10^2=100"]},
{q:`Divide 90 in the ratio 2:1. Find the larger share.`,a:["60"]},
{q:`Simplify the ratio 18:24.`,a:["3:4"]},
{q:`If 4 kg of rice costs ‚Çπ160, find the cost of 1 kg.`,a:["40"]},
{q:`Find the next term: 2, 4, 6, 8, __`,a:["10"]},
{q:`Find the sum of the first 5 natural numbers.`,a:["15"]},
{q:`Find the 5th term of the sequence n¬≤.`,a:["25"]},
{q:`Find the mean of 2, 4, 6, 8.`,a:["5"]},
{q:`Find the range of the data set: 3, 7, 10, 15.`,a:["12"]},
{q:`Solve: 3x ‚àí 9 = 0.`,a:["3"]},
{q:`Solve: 2(x‚àí4)=10.`,a:["9"]},
{q:`Simplify: (x¬≤)(x¬≥).`,a:["x^5"]},
{q:`Evaluate 15% of 200.`,a:["30"]},
{q:`Find ‚àö169.`,a:["13"]},
{q:`Evaluate 2¬≥ √ó 4.`,a:["32"]},
{q:`Solve: 100 √∑ (5√ó4).`,a:["5"]},
{q:`A field yields 120 kg per hour. How much is harvested in 5 hours?`,a:["600"]},
{q:`If 20% of a 500 kg harvest is pulses, find the mass of pulses.`,a:["100"]},
{q:`A farmer sells rice at ‚Çπ50 per kg. How much does 8 kg cost?`,a:["400"]},
{q:`Temperature rises from 18¬∞C to 30¬∞C. Find the increase.`,a:["12"]},
{q:`Evaluate: 7¬≤ ‚àí 3¬≤.`,a:["40"]},
{q:`Simplify 2‚Åµ √∑ 2¬≥.`,a:["4"]}
];

const questions=compulsory.concat(pool.sort(()=>Math.random()-0.5));

/* GAME LOGIC */
let index=0,score=0,timeLeft=120,timer;
let gameEnded = false;

function startGame(){
  showQuestion();
  updateStatus();
  timer = setInterval(() => {
    timeLeft--;
    updateStatus();

    if (timeLeft <= 0) {
      clearInterval(timer);
      endGame();
    }
  }, 1000);
}

function normalize(x){
  return x.toLowerCase().replace(/[^a-z0-9:+^=.-]/g,"");
}

function showQuestion(){
  questionNumber.textContent="Question "+(index+1);
  questionText.innerHTML=questions[index].q.replace(/\n/g,"<br><br>");
  skipBtn.classList.toggle("hidden",index<6);
}

submitBtn.onclick=()=>{
  if(gameEnded) return;
  if(!answerInput.value.trim()) return;
  const user=normalize(answerInput.value);
  const correct=questions[index].a.some(a=>normalize(a)===user);
  score+=correct?5:-2;
  nextQuestion();
};

skipBtn.onclick=()=>{
  if(gameEnded) return;
  nextQuestion();
};

function nextQuestion(){
  answerInput.value="";
  index++;
  if(index>=questions.length){
    endGame();
  }
  else showQuestion();
}

function updateStatus(){
  scoreEl.textContent=score;
  timeEl.textContent=Math.floor(timeLeft/60)+":"+String(timeLeft%60).padStart(2,"0");
}

async function endGame(){
  if(gameEnded) return;
  gameEnded = true;

  clearInterval(timer);

  // ‚úÖ FORCE UI CHANGE FIRST
  gamePage.classList.add("hidden");
  leaderboardPage.classList.remove("hidden");
  leaderboard.innerHTML = "<p>Loading leaderboard...</p>";

  localStorage.setItem("completedGame","yes");

  try {
    await db.collection("leaderboard").add({
      name: nameInput.value,
      score: score,
      time: Date.now()
    });

    const snap = await db.collection("leaderboard")
      .orderBy("score","desc")
      .orderBy("time","asc")
      .limit(10)
      .get();

    leaderboard.innerHTML = "";
    let r = 1;

    snap.forEach(d=>{
      const x = d.data();
      leaderboard.innerHTML += `
        <div class="leader">
          <span>${r}. ${x.name} ${r<=3?["ü•á","ü•à","ü•â"][r-1]:""}</span>
          <span>${x.score}</span>
        </div>`;
      r++;
    });

  } catch (e) {
    leaderboard.innerHTML = "<p>Error loading leaderboard</p>";
    console.error(e);
  }
}
</script>
</body>
</html>
